<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Apache BookKeeper Disk Usage With Apache Pulsar - Pulsar Neighborhood</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Theoretical attempts to size up disk space for the Apache BookKeeper cluster backing Apache Pulsar occasionally raises questions of why the BookKeeper uses more space in practice than anticipated. Understanding the factors involved in the disk utilization and possible configuration options is important for more precise capacity planning.
Let’s look at the specific factors affecting disk usage.
Pulsar side Pulsar uses BookKeeper to persist data to the disk. BookKeeper does not delete the data unless Pulsar “tells” that it is safe to delete."><meta property="og:title" content="Apache BookKeeper Disk Usage With Apache Pulsar - Pulsar Neighborhood"><meta property="og:type" content="article"><meta property="og:url" content="https://www.pulsar-neighborhood.io/articles/apache-bookkeeper-disk-usage-with-apache-pulsar/"><meta property="og:image" content="https://user-images.githubusercontent.com/16946028/178064536-f4473866-cb4b-4154-a4a3-ba02d381fef3.png"><meta property="og:description" content="Theoretical attempts to size up disk space for the Apache BookKeeper cluster backing Apache Pulsar occasionally raises questions of why the BookKeeper uses more space in practice than anticipated. Understanding the factors involved in the disk utilization and possible configuration options is important for more precise capacity planning.
Let’s look at the specific factors affecting disk usage.
Pulsar side Pulsar uses BookKeeper to persist data to the disk. BookKeeper does not delete the data unless Pulsar “tells” that it is safe to delete."><meta name=twitter:site content="@pulsar_neighbor"><meta name=twitter:creator content="@pulsar_neighbor"><link rel=alternate type=application/rss+xml href=/index.xml title="Site Title"><meta name=google-site-verification content="m-1Z-0k0EvG9PD7R24pKuETSaBpEvqoXgOYT-0MtuPU"><link rel=icon href=https://www.pulsar-neighborhood.io/favicon.png><link rel=canonical href=https://www.pulsar-neighborhood.io/articles/apache-bookkeeper-disk-usage-with-apache-pulsar/><link rel=stylesheet href=/css/style.32ad96ee983b063b549f59db931afb8f0db25424bf2d687e1122748a7d183f73.css><style>.ctct-form-defaults{padding:15px!important}</style><script type=application/ld+json>[{"@context":"http://schema.org","@type":"WebPage","name":"Pulsar Neighborhood - Apache BookKeeper Disk Usage With Apache Pulsar","description":"","publisher":{"@type":"Organization","name":"Pulsar Neighborhood"}},{"@context":"http://schema.org","@type":"BlogPosting","image":"https://user-images.githubusercontent.com/16946028/178064536-f4473866-cb4b-4154-a4a3-ba02d381fef3.png","url":"https:\/\/www.pulsar-neighborhood.io\/articles\/apache-bookkeeper-disk-usage-with-apache-pulsar\/","publisher":"Pulsar Neighborhood","headline":"Apache BookKeeper Disk Usage With Apache Pulsar","dateCreated":"2022-07-08 16:21:04 -0400 -0400","datePublished":"2022-07-08 16:21:04 -0400 -0400","dateModified":"2022-07-08 16:21:04 -0400 -0400","inLanguage":"en-US","isFamilyFriendly":"true","copyrightYear":"2022","copyrightHolder":"","author":{"@type":"Person","name":"Andrey Yegorov","url":"https://www.pulsar-neighborhood.io"},"mainEntityOfPage":"True","articleSection":["pulsar-components"],"articleBody":"\u003cp\u003eTheoretical attempts to size up disk space for the Apache BookKeeper cluster backing Apache Pulsar occasionally raises questions of why the BookKeeper uses more space in practice than anticipated. Understanding the factors involved in the disk utilization and possible configuration options is important for more precise capacity planning.\u003c\/p\u003e\n\u003cp\u003eLet’s look at the specific factors affecting disk usage.\u003c\/p\u003e\n\u003ch2 id=\u0022pulsar-side\u0022\u003ePulsar side\u003c\/h2\u003e\n\u003cp\u003ePulsar uses BookKeeper to persist data to the disk. BookKeeper does not delete the data unless Pulsar “tells” that it is safe to delete. BookKeeper’s minimal unit of deletion is ledger. Pulsar has to wait until all the messages in the given ledger can be deleted before deleting it.\u003c\/p\u003e\n\u003cp\u003eBookKeeper does not delete the ledger from the disk immediately, and we’ll discuss reasons for this a little bit later. Nevertheless, for all practical reasons, the data becomes unavailable but the disk space is released with the delay.\u003c\/p\u003e\n\u003cp\u003ePulsar’s topic is a sequence of ledgers (also referred to as a \u003ca href=\u0022https:\/\/pulsar.apache.org\/docs\/en\/concepts-architecture-overview\/#managed-ledgers\u0022 target=\u0022_blank\u0022\u003eManaged Ledger\u003c\/a\u003e):\u003c\/p\u003e\n\u003cpre tabindex=\u00220\u0022\u003e\u003ccode class=\u0022language-log\u0022 data-lang=\u0022log\u0022\u003eTopic = [ledger 1, ledger2, ledger 3, ...]\n\u003c\/code\u003e\u003c\/pre\u003e\u003cp\u003eThe ledger is a sequence of entries (think Pulsar messages, for simplicity).\u003c\/p\u003e\n\u003cp\u003eWhen all the messages from ledger 1 reach the state where they can be safely deleted, Pulsar will delete ledger 1. After the deletion of one ledger, the topic will look like\u003c\/p\u003e\n\u003cpre tabindex=\u00220\u0022\u003e\u003ccode class=\u0022language-log\u0022 data-lang=\u0022log\u0022\u003eTopic = [ledger2, ledger 3, ...]\n\u003c\/code\u003e\u003c\/pre\u003e\u003cp\u003eand the ledger 1 is deleted in BookKeeper.\u003c\/p\u003e\n\u003cp\u003ePulsar decides that the ledger is safe to delete (“trim the topic”) when all subscribers processed all messages within the ledger and message retention policy reached.\u003c\/p\u003e\n\u003cp\u003ePossible contributing factors for the delays are:\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe ledger compaction process (for \u003ca href=\u0022https:\/\/pulsar.apache.org\/docs\/en\/concepts-topic-compaction\/\u0022 target=\u0022_blank\u0022\u003ecompactable topics\u003c\/a\u003e)\u003c\/li\u003e\n\u003cli\u003e\u003ca href=\u0022https:\/\/pulsar.apache.org\/docs\/en\/concepts-messaging\/#message-retention-and-expiry\u0022 target=\u0022_blank\u0022\u003eMessage retention \u0026amp;amp; expiry\u003c\/a\u003e and related \u003ca href=\u0022https:\/\/pulsar.apache.org\/docs\/en\/cookbooks-retention-expiry\/\u0022 target=\u0022_blank\u0022\u003esettings\u003c\/a\u003e affect the delay in topic trimming:\n\u003cul\u003e\n\u003cli\u003ethe time\/size expiration policies, message TTL, and the speed of consumption on existing subscriptions\u003c\/li\u003e\n\u003cli\u003e\u003ca href=\u0022https:\/\/pulsar.apache.org\/docs\/en\/reference-configuration\/#broker\u0022 target=\u0022_blank\u0022\u003eLedger rollover configuration\u003c\/a\u003e (size\/time\/number of entries based policy to start new ledger in BookKeeper)\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003c\/li\u003e\n\u003cli\u003e\u003ca href=\u0022https:\/\/pulsar.apache.org\/docs\/en\/tiered-storage-overview\/\u0022 target=\u0022_blank\u0022\u003eTiered Storage\u003c\/a\u003e’s data offloading, if it is being used\u003c\/li\u003e\n\u003cli\u003eDelays in consumer reads\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003cp\u003eBookKeeper also used to store data other than the messages in user-defined persistent topics:\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\u0022https:\/\/pulsar.apache.org\/docs\/en\/window-functions-context\/#state-storage\u0022 target=\u0022_blank\u0022\u003eState Store\u003c\/a\u003e uses BookKeeper to persist data\u003c\/li\u003e\n\u003cli\u003ePulsar uses internal (system) topics to store some data\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003ch2 id=\u0022bookkeeper-side\u0022\u003eBookKeeper side\u003c\/h2\u003e\n\u003cp\u003eTwo major factors affect disk usage on the BookKeeper side:\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003eSize amplification. Size amplification is a result of extra internal data that BookKeeper needs to store in order to guarantee data safety and reliability, and it is a permanent addition to the user data.\u003c\/li\u003e\n\u003cli\u003eDelayed deletion a.k.a garbage collection. Garbage collection is used to reclaim space while reducing the performance impact and maintaining the data safety. It temporarily increases disk usage in order to free up space later.\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003ch3 id=\u0022size-amplification\u0022\u003eSize amplification\u003c\/h3\u003e\n\u003cp\u003eSize amplification happens at multiple levels:\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003eData level\n\u003cul\u003e\n\u003cli\u003eBookKeeper adds checksum and some \u003ca href=\u0022https:\/\/bookkeeper.apache.org\/docs\/getting-started\/concepts\/#entries\u0022 target=\u0022_blank\u0022\u003emetadata\u003c\/a\u003e to every entry it stores. This is not a lot of data but it is a constant size which may become a larger percentage of space used e.g. for small entries\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003c\/li\u003e\n\u003cli\u003e\u003ca href=\u0022https:\/\/bookkeeper.apache.org\/docs\/getting-started\/concepts\/\u0022 target=\u0022_blank\u0022\u003eBookie\u003c\/a\u003e level\n\u003cul\u003e\n\u003cli\u003eJournal. Each bookie writes data twice (journal and, later, entry log) and keeps a few older journal files.\u003c\/li\u003e\n\u003cli\u003eIndexes. Bookie needs to keep an index for each ledger to locate entries. Indexes don’t take a lot of space but need to be considered. The index can be stored as flat files or in the embedded RocksDB. In the case of Pulsar, the \u003ca href=\u0022https:\/\/bookkeeper.apache.org\/docs\/reference\/config\/\u0022 target=\u0022_blank\u0022\u003eledgerStorageClass\u003c\/a\u003e is configured to use DbLedgerStorage by default; DbLedgerStorage is backed by RocksDB. RocksDB uses garbage collection\/compaction internally so it can use some extra space until compaction completes.\u003c\/li\u003e\n\u003cli\u003eDisk usage threshold \u003ca href=\u0022https:\/\/bookkeeper.apache.org\/docs\/reference\/config\/\u0022 target=\u0022_blank\u0022\u003econfiguration\u003c\/a\u003e. In order for the Garbage Collection to work even when the disk is “full”, the bookie reserves some free space and switches to read-only mode when diskUsageThreshold is reached.\u003c\/li\u003e\n\u003cli\u003eFile system nuances. Various file systems may incur additional overhead, e.g. XFS speculative preallocation. Typically this is not a problem for BookKeeper but can become a challenge if entry log per ledger is enabled and the bookie has many large files open for writing.\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003c\/li\u003e\n\u003cli\u003eCluster-wide amplification:\n\u003cul\u003e\n\u003cli\u003eReplication is used to ensure data reliability in case of bookie node failure.It means that each entry will be written [Write Quorum] times across the cluster.\u003c\/li\u003e\n\u003cli\u003eTemporary over-replication is possible. It can happen as a result of a bookie node failure, data autorecovery, and later recovery of the failed node. \u003ca href=\u0022https:\/\/bookkeeper.apache.org\/docs\/reference\/config\/\u0022 target=\u0022_blank\u0022\u003eAutorecovery settings and garbage collector delays\u003c\/a\u003e are contributing factors to the delay in over-replication correction.\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003ch3 id=\u0022garbage-collection\u0022\u003eGarbage Collection\u003c\/h3\u003e\n\u003cp\u003eData in BookKeeper is stored in so-called “entry logs” where data from multiple ledgers is interleaved. The entry log is immutable which means that once written it is never modified. It also means that the minimal unit of deletion from the disk is the whole entry log. In order to delete the entry log, BookKeeper needs to rewrite data from surviving ledgers into a new entry log first. To reduce performance impact of this process, the garbage collection runs with delays and only on entry logs with deleted data above specific thresholds.\u003c\/p\u003e\n\u003cp\u003eDetails of this process can be found in BookKeeper \u003ca href=\u0022https:\/\/bookkeeper.apache.org\/docs\/getting-started\/concepts#data-compaction\u0022 target=\u0022_blank\u0022\u003edocumentation\u003c\/a\u003e.\u003c\/p\u003e\n\u003cp\u003eBookKeeper allows using an entry log per ledger which can be enabled by entryLogPerLedgerEnabled configuration parameter. It greatly improves time to release space after the ledger deletion as it eliminates need in rewriting data. It may result in other problems, such as slow writes, file system not handling too many files, etc. These side effects depend on the number of ledgers in the system, typical size of the ledgers, etc. and should be considered before using it in production.\u003c\/p\u003e\n\u003ch2 id=\u0022conclusion\u0022\u003eConclusion\u003c\/h2\u003e\n\u003cp\u003eDisk space usage is affected by multiple factors beyond simple (estimated data size * number of replicas) formula. Many parameters contribute to the disk space utilization and their effect should be considered during capacity planning and for tuning of Pulsar and BookKeeper.\u003c\/p\u003e\n"}]</script></head><body class='page bg-secondary'><div id=main-menu-mobile class=main-menu-mobile><ul></ul></div><div class=wrapper><div class='header sticky-top bg-secondary'><div class=container><div class=logo><a href=https://www.pulsar-neighborhood.io><img src=/svg/Pulsar-Neighborhood-Logo.svg class=img-fluid></a></div><div class=logo-mobile><a href=https://www.pulsar-neighborhood.io><img src=/svg/Neighborhood-Icon.svg class=img-fluid></a></div><div id=main-menu class=main-menu><ul><li><a href=/about><span>About The Pulsar Neighborhood</span></a></li><li><a href=https://pulsar.apache.org/ target=_blank><span>About Apache Pulsar</span></a></li><li><a href=https://pulsar.apache.org/docs/en/standalone/ target=_blank><span></span>Project Documentation</span></a></li><li><a href=/index.xml><img src=/svg/square-rss-solid.svg title="Subscribe to The Pulsar Neighborhood feed" class=img-fluid style=height:30px></a></li></ul></div><button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button>
<span class=hamburger-box><span class=hamburger-inner></span></span></button></div></div><div class="container pt-2 pb-3"><div class=row><div class="col-0 col-md-2"><div class=sidebar><div class=mb-2><a href=/guides/getting-started><div class="col-12 btn btn-success">Get Started with Pulsar</div></a></div><div class="spotlight mb-2 border border-primary rounded"><div class="row bg-primary no-gutters"><div class="col-12 text-secondary p-1">&nbsp;Find Topics</div></div><div class=p-1><div class="row no-gutters"><div class="col-12 mb-1"><h4>Category</h4><ul><li>&nbsp;<a class=text-decoration-none href=/categories/at-the-edge>At the Edge</a> [3]</li><li>&nbsp;<a class=text-decoration-none href=/categories/cluster-administration>Cluster Administration</a> [3]</li><li>&nbsp;<a class=text-decoration-none href=/categories/getting-started>Getting Started</a> [15]</li><li>&nbsp;<a class=text-decoration-none href=/categories/machine-learning>Machine Learning</a> [2]</li><li>&nbsp;<a class=text-decoration-none href=/categories/moving-to-pulsar>Moving to Pulsar</a> [10]</li><li>&nbsp;<a class=text-decoration-none href=/categories/pulsar-architecture>Pulsar Architecture</a> [10]</li><li>&nbsp;<a class=text-decoration-none href=/categories/pulsar-components>Pulsar Components</a> [8]</li><li>&nbsp;<a class=text-decoration-none href=/categories/use-cases>Use Cases</a> [4]</li></ul></div><div class=col-12><h4>View All</h4><div class="mt-1 pb-1"><a href=/articles>Articles</a>
&nbsp;|&nbsp;<a href=/guides>Guides</a>
&nbsp;|&nbsp;<a href=/videos>Videos</a></div></div></div></div></div></div></div><div class="col-12 col-md-8"><div class=container><header class=mb-3><div class=pb-2><img src=https://user-images.githubusercontent.com/16946028/178064536-f4473866-cb4b-4154-a4a3-ba02d381fef3.png alt="Apache BookKeeper Disk Usage With Apache Pulsar" class=img-fluid style=max-width:85%;max-height:200px></div><h1>Apache BookKeeper Disk Usage With Apache Pulsar</h1><div class="row no-gutters"><div class="col col-auto mr-1">Categories:</div><div class="col col-auto"><a class=text-decoration-none href=/categories/pulsar-components>Pulsar Components</a></div></div></header><div class="row mb-3 no-gutters border-top border-bottom"><div class=col-2><ul class="list-group list-group-horizontal mt-1 mb-1"><li class="list-group-item flex-fill border-0 p-0 mr-3"><a href="https://www.linkedin.com/sharing/share-offsite/?mini=true&url=https%3a%2f%2fwww.pulsar-neighborhood.io%2farticles%2fapache-bookkeeper-disk-usage-with-apache-pulsar%2f&title=Apache%20BookKeeper%20Disk%20Usage%20With%20Apache%20Pulsar" target=_blank><img src=/svg/linkedin-in-brands.svg title="Share this on LinkedIn" class=img-fluid></a></li><li class="list-group-item flex-fill border-0 p-0 mr-3"><a target=_blank href="https://twitter.com/intent/tweet?text=Apache%20BookKeeper%20Disk%20Usage%20With%20Apache%20Pulsar&url=https%3a%2f%2fwww.pulsar-neighborhood.io%2farticles%2fapache-bookkeeper-disk-usage-with-apache-pulsar%2f&hashtags=apachepulsar&via=pulsar_neighbor"><img src=/svg/twitter-brands.svg title="Share this on Twitter" class=img-fluid></a></li></ul></div><div class="col text-right"><span class=text-muted>Author:</span> Andrey Yegorov<br><span class=text-muted>Published:</span> July 8, 2022</div><div class="col-1 ml-1"><img src=https://user-images.githubusercontent.com/16946028/178064306-85871c22-18fd-4144-8dba-07f090b94461.png alt class=img-fluid style=max-height:100px></div></div><article><p>Theoretical attempts to size up disk space for the Apache BookKeeper cluster backing Apache Pulsar occasionally raises questions of why the BookKeeper uses more space in practice than anticipated. Understanding the factors involved in the disk utilization and possible configuration options is important for more precise capacity planning.</p><p>Let’s look at the specific factors affecting disk usage.</p><h2 id=pulsar-side>Pulsar side</h2><p>Pulsar uses BookKeeper to persist data to the disk. BookKeeper does not delete the data unless Pulsar “tells” that it is safe to delete. BookKeeper’s minimal unit of deletion is ledger. Pulsar has to wait until all the messages in the given ledger can be deleted before deleting it.</p><p>BookKeeper does not delete the ledger from the disk immediately, and we’ll discuss reasons for this a little bit later. Nevertheless, for all practical reasons, the data becomes unavailable but the disk space is released with the delay.</p><p>Pulsar’s topic is a sequence of ledgers (also referred to as a <a href=https://pulsar.apache.org/docs/en/concepts-architecture-overview/#managed-ledgers target=_blank>Managed Ledger</a>):</p><pre tabindex=0><code class=language-log data-lang=log>Topic = [ledger 1, ledger2, ledger 3, ...]
</code></pre><p>The ledger is a sequence of entries (think Pulsar messages, for simplicity).</p><p>When all the messages from ledger 1 reach the state where they can be safely deleted, Pulsar will delete ledger 1. After the deletion of one ledger, the topic will look like</p><pre tabindex=0><code class=language-log data-lang=log>Topic = [ledger2, ledger 3, ...]
</code></pre><p>and the ledger 1 is deleted in BookKeeper.</p><p>Pulsar decides that the ledger is safe to delete (“trim the topic”) when all subscribers processed all messages within the ledger and message retention policy reached.</p><p>Possible contributing factors for the delays are:</p><ul><li>The ledger compaction process (for <a href=https://pulsar.apache.org/docs/en/concepts-topic-compaction/ target=_blank>compactable topics</a>)</li><li><a href=https://pulsar.apache.org/docs/en/concepts-messaging/#message-retention-and-expiry target=_blank>Message retention &amp;amp; expiry</a> and related <a href=https://pulsar.apache.org/docs/en/cookbooks-retention-expiry/ target=_blank>settings</a> affect the delay in topic trimming:<ul><li>the time/size expiration policies, message TTL, and the speed of consumption on existing subscriptions</li><li><a href=https://pulsar.apache.org/docs/en/reference-configuration/#broker target=_blank>Ledger rollover configuration</a> (size/time/number of entries based policy to start new ledger in BookKeeper)</li></ul></li><li><a href=https://pulsar.apache.org/docs/en/tiered-storage-overview/ target=_blank>Tiered Storage</a>’s data offloading, if it is being used</li><li>Delays in consumer reads</li></ul><p>BookKeeper also used to store data other than the messages in user-defined persistent topics:</p><ul><li><a href=https://pulsar.apache.org/docs/en/window-functions-context/#state-storage target=_blank>State Store</a> uses BookKeeper to persist data</li><li>Pulsar uses internal (system) topics to store some data</li></ul><h2 id=bookkeeper-side>BookKeeper side</h2><p>Two major factors affect disk usage on the BookKeeper side:</p><ul><li>Size amplification. Size amplification is a result of extra internal data that BookKeeper needs to store in order to guarantee data safety and reliability, and it is a permanent addition to the user data.</li><li>Delayed deletion a.k.a garbage collection. Garbage collection is used to reclaim space while reducing the performance impact and maintaining the data safety. It temporarily increases disk usage in order to free up space later.</li></ul><h3 id=size-amplification>Size amplification</h3><p>Size amplification happens at multiple levels:</p><ul><li>Data level<ul><li>BookKeeper adds checksum and some <a href=https://bookkeeper.apache.org/docs/getting-started/concepts/#entries target=_blank>metadata</a> to every entry it stores. This is not a lot of data but it is a constant size which may become a larger percentage of space used e.g. for small entries</li></ul></li><li><a href=https://bookkeeper.apache.org/docs/getting-started/concepts/ target=_blank>Bookie</a> level<ul><li>Journal. Each bookie writes data twice (journal and, later, entry log) and keeps a few older journal files.</li><li>Indexes. Bookie needs to keep an index for each ledger to locate entries. Indexes don’t take a lot of space but need to be considered. The index can be stored as flat files or in the embedded RocksDB. In the case of Pulsar, the <a href=https://bookkeeper.apache.org/docs/reference/config/ target=_blank>ledgerStorageClass</a> is configured to use DbLedgerStorage by default; DbLedgerStorage is backed by RocksDB. RocksDB uses garbage collection/compaction internally so it can use some extra space until compaction completes.</li><li>Disk usage threshold <a href=https://bookkeeper.apache.org/docs/reference/config/ target=_blank>configuration</a>. In order for the Garbage Collection to work even when the disk is “full”, the bookie reserves some free space and switches to read-only mode when diskUsageThreshold is reached.</li><li>File system nuances. Various file systems may incur additional overhead, e.g. XFS speculative preallocation. Typically this is not a problem for BookKeeper but can become a challenge if entry log per ledger is enabled and the bookie has many large files open for writing.</li></ul></li><li>Cluster-wide amplification:<ul><li>Replication is used to ensure data reliability in case of bookie node failure.It means that each entry will be written [Write Quorum] times across the cluster.</li><li>Temporary over-replication is possible. It can happen as a result of a bookie node failure, data autorecovery, and later recovery of the failed node. <a href=https://bookkeeper.apache.org/docs/reference/config/ target=_blank>Autorecovery settings and garbage collector delays</a> are contributing factors to the delay in over-replication correction.</li></ul></li></ul><h3 id=garbage-collection>Garbage Collection</h3><p>Data in BookKeeper is stored in so-called “entry logs” where data from multiple ledgers is interleaved. The entry log is immutable which means that once written it is never modified. It also means that the minimal unit of deletion from the disk is the whole entry log. In order to delete the entry log, BookKeeper needs to rewrite data from surviving ledgers into a new entry log first. To reduce performance impact of this process, the garbage collection runs with delays and only on entry logs with deleted data above specific thresholds.</p><p>Details of this process can be found in BookKeeper <a href=https://bookkeeper.apache.org/docs/getting-started/concepts#data-compaction target=_blank>documentation</a>.</p><p>BookKeeper allows using an entry log per ledger which can be enabled by entryLogPerLedgerEnabled configuration parameter. It greatly improves time to release space after the ledger deletion as it eliminates need in rewriting data. It may result in other problems, such as slow writes, file system not handling too many files, etc. These side effects depend on the number of ledgers in the system, typical size of the ledgers, etc. and should be considered before using it in production.</p><h2 id=conclusion>Conclusion</h2><p>Disk space usage is affected by multiple factors beyond simple (estimated data size * number of replicas) formula. Many parameters contribute to the disk space utilization and their effect should be considered during capacity planning and for tuning of Pulsar and BookKeeper.</p></article><div class="row border border-primary rounded"><div class="col p-2"><h3>You might also like...</h3><div class=row><div class="col text-center p-2"><div><a href=/articles/how-schemas-make-the-world-go-round/><img src=https://user-images.githubusercontent.com/16946028/176909975-6cd31a0d-f5f6-4928-8b21-adf5c5156736.png alt class=img-fluid style=max-width:150px></a></div><div class=pt-2><a href=/articles/how-schemas-make-the-world-go-round/>How Schemas Make the World Go Round</a></div><div class=pt-2>The Apache Pulsar Schema is one of the most critical components of Apache Pulsar, an open-source …</div></div><div class="col text-center p-2"><div><a href=/articles/the-difference-between-persistent-and-non-persistent-topics-in-apache-pulsar/><img src=https://user-images.githubusercontent.com/16946028/175392241-c8347127-d310-4acd-9a99-0e757bd5e98f.png alt class=img-fluid style=max-width:150px></a></div><div class=pt-2><a href=/articles/the-difference-between-persistent-and-non-persistent-topics-in-apache-pulsar/>The Difference Between Persistent and Non Persistent Topics in Apache Pulsar</a></div><div class=pt-2>This article will explore what Pulsar topics are, the differences between persistent and …</div></div><div class="col text-center p-2"><div class=pt-2><a href=/articles/integrating-apache-druid-with-apache-pulsar/>Integrating Apache Druid With Apache Pulsar</a></div><div class=pt-2>With companies adopting the event streaming pattern, analytics has to become more "realtime" too. A …</div></div></div></div></div><br><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="pulsar-neighborhood",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div><div class="col-0 col-md-2"><nav class="navbar navbar-light mb-3"><div class=row><div class=col-12><h4>In this article</h4></div><div class="col-12 border-left border-primary pr-0"><nav id=TableOfContents><ul><li><a href=#pulsar-side>Pulsar side</a></li><li><a href=#bookkeeper-side>BookKeeper side</a><ul><li><a href=#size-amplification>Size amplification</a></li><li><a href=#garbage-collection>Garbage Collection</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div></nav></div></div></div></div><div class="sub-footer m-5"><div class=row><div class="col-12 text-center"><a href=https://github.com/pulsar-neighborhood/pulsar-neighborhood.github.io/blob/main/content/articles/Apache-BookKeeper-Disk-Usage-with-Apache-Pulsar.md target=_blank>Improve this page</a></div></div><div class="col-8 offset-2"><hr class="bg-primary text-primary"></div><div class="sub-footer-inner mt-2"><div><div class=mb-1>Pulsar Neighborhood</div><div><ul><li style=width:40px><a href=https://github.com/pulsar-neighborhood target=_blank><img src=/svg/github-brands.svg title="Pulsar Neighborhood on GitHub" class=img-fluid></a></li><li class="ml-3 mr-1" style=width:40px><a href=https://twitter.com/pulsar_neighbor target=_blank><img src=/svg/twitter-brands.svg title="Pulsar Neighborhood on Twitter" class=img-fluid></a></li><li style=width:40px><a href=https://www.youtube.com/c/ApachePulsarNeighborhood target=_blank><img src=/svg/youtube-brands.svg title="Pulsar Neighborhood on YouTube" class=img-fluid></a></li><li style=width:40px><a href=https://datastudio.google.com/reporting/743d9f31-c80f-4e60-b520-730631d3c250 target=_blank><img src=/png/google-analytics.png title="Pulsar Neighborhood analytics" class=img-fluid></a></li></ul></div></div><div class=p-5></div><div><div class=mb-1>Apache Pulsar</div><div><ul><li style=width:40px><a href=https://pulsar.apache.org target=_blank><img src=/png/pulsar-icon.jpg title="Apache Pulsar project home" class=img-fluid></a></li><li class="ml-3 mr-1" style=width:40px><a href=https://github.com/apache-pulsar target=_blank><img src=/svg/github-brands.svg title="Apache Pulsar on GitHub" class=img-fluid></a></li><li class=mr-1 style=width:40px><a href=https://twitter.com/Apache_Pulsar target=_blank><img src=/svg/twitter-brands.svg title="Apache Pulsar on Twitter" class=img-fluid></a></li><li class=mr-1 style=width:30px><a href=https://stackoverflow.com/questions/tagged/apache-pulsar target=_blank><img src=/svg/stack-overflow-brands.svg title="Apache Pulsar on Stackoverflow" class=img-fluid></a></li><li style=width:40px><a href=https://apache-pulsar.slack.com target=_blank><img src=/svg/slack-brands.svg title="Apache Pulsar slack channel" class=img-fluid></a></li></ul></div></div></div><div class="row text-center mb-3"><div class=col-12><a class="btn btn-info" href=https://pulsar.apache.org/community/ target=_blank>Join the Pulsar community</a></div></div><div class="row text-center"><div class="col-12 text-center"><div><a href=https://github.com/pulsar-neighborhood/pulsar-neighborhood.github.io/issues/new/choose>Contact Us</a></div></div></div></div><script type=text/javascript src=/js/scripts.min.8efe3e711319c2d0a300a084134e3f3bedcb60dce21f1e0ef12767f654242b44.js></script>
<script src=https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js integrity=sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF crossorigin=anonymous></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8S9SD43SBH"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8S9SD43SBH")</script></body></html>
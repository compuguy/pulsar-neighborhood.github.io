<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Integrating Apache Druid With Apache Pulsar - Pulsar Neighborhood</title>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Apache Druid is a great database for event analytics. Druid connects natively to various event streaming systems like Kafka & AWS Kinesis. Read to find out more."><meta property="og:title" content="Integrating Apache Druid With Apache Pulsar - Pulsar Neighborhood"><meta property="og:type" content="article"><meta property="og:url" content="https://www.pulsar-neighborhood.io/articles/integrating-apache-druid-with-apache-pulsar/"><meta property="og:image" content="https://www.pulsar-neighborhood.io/png/blue-logotype.png"><meta name=description content="Apache Druid is a great database for event analytics. Druid connects natively to various event streaming systems like Kafka & AWS Kinesis. Read to find out more."><meta name=twitter:site content="@pulsar_neighbor"><meta name=twitter:creator content="@pulsar_neighbor"><link rel=alternate type=application/rss+xml href=/index.xml title="Site Title"><meta name=google-site-verification content="m-1Z-0k0EvG9PD7R24pKuETSaBpEvqoXgOYT-0MtuPU"><link rel=icon href=https://www.pulsar-neighborhood.io/favicon.png><link rel=canonical href=https://www.pulsar-neighborhood.io/articles/integrating-apache-druid-with-apache-pulsar/><link rel=stylesheet href=/css/style.32ad96ee983b063b549f59db931afb8f0db25424bf2d687e1122748a7d183f73.css><style>.ctct-form-defaults{padding:15px!important}</style><script type=application/ld+json>[{"@context":"http://schema.org","@type":"WebPage","name":"Pulsar Neighborhood - Integrating Apache Druid With Apache Pulsar","description":"Apache Druid is a great database for event analytics. Druid connects natively to various event streaming systems like Kafka \u0026 AWS Kinesis. Read to find out more.","publisher":{"@type":"Organization","name":"Pulsar Neighborhood"},"keywords":["apache druid"]},{"@context":"http://schema.org","@type":"BlogPosting","image":"https://www.pulsar-neighborhood.io/images/blue-logotype.png","url":"https:\/\/www.pulsar-neighborhood.io\/articles\/integrating-apache-druid-with-apache-pulsar\/","publisher":"Pulsar Neighborhood","headline":"Integrating Apache Druid With Apache Pulsar","dateCreated":"2022-05-18 10:57:26 -0400 -0400","datePublished":"2022-05-18 10:57:26 -0400 -0400","dateModified":"2022-05-18 10:57:26 -0400 -0400","inLanguage":"en-US","isFamilyFriendly":"true","copyrightYear":"2022","copyrightHolder":"","author":{"@type":"Person","name":"Hellmar Becker","url":"https://www.pulsar-neighborhood.io"},"mainEntityOfPage":"True","articleSection":["machine-learning, moving-to-pulsar"],"keywords":["apache druid"],"articleBody":"\u003cp\u003eThis blog post originally appeared on \u003ca href=\u0022https:\/\/blog.hellmar-becker.de\/2022\/04\/25\/integrating-apache-druid-with-apache-pulsar\/\u0022 target=\u0022_blank\u0022\u003eblog.hellmar-becker.de\u003c\/a\u003e\u003c\/p\u003e\n\u003cp\u003e\u003cimg src=\u0022https:\/\/user-images.githubusercontent.com\/1042872\/168392825-24f2ef83-c646-46dc-a5e5-c20eb7f7f0c5.png\u0022 alt=\u0022Pulsar and Druid banner\u0022\u003e\u003c\/p\u003e\n\u003cp\u003eWith companies adopting the \u003ca href=\u0022https:\/\/medium.com\/capital-one-tech\/event-streaming-an-additional-architectural-style-to-supplement-api-design-703c4f801722\u0022 target=\u0022_blank\u0022\u003eevent streaming pattern\u003c\/a\u003e, analytics has to become more \u0026ldquo;realtime\u0026rdquo; too. A great database for event analytics is \u003ca href=\u0022https:\/\/druid.apache.org\/\u0022 target=\u0022_blank\u0022\u003eApache Druid\u003c\/a\u003e. Druid connects natively to various event streaming systems such as Kafka and AWS Kinesis.\u003c\/p\u003e\n\u003cp\u003eOne of the most advanced modern event streaming platforms is \u003ca href=\u0022https:\/\/pulsar.apache.org\/\u0022 target=\u0022_blank\u0022\u003eApache Pulsar\u003c\/a\u003e. Pulsar has a cloud native architecture that separates the storage layer from the message brokers, claiming unprecendented scalability and flexibility. Sure it would be great to stream events directly from Pulsar into Druid!\u003c\/p\u003e\n\u003cp\u003eThe idea has been discussed before \u003ca href=\u0022https:\/\/imply.io\/blog\/community-spotlight-apache-pulsar-and-apache-druid-get-close\/\u0022 target=\u0022_blank\u0022\u003eby the Imply and StreamNative teams\u003c\/a\u003e, but up until recently no turnkey solution existed. Pulsar offered a drop-in client library with call compatibility to the Kafka libraries, but using it would usually require rebuilding the entire application, which is not for everyone.\u003c\/p\u003e\n\u003cp\u003eRecently, the folks at \u003ca href=\u0022https:\/\/streamnative.io\/\u0022 target=\u0022_blank\u0022\u003eStreamNative\u003c\/a\u003e released \u003ca href=\u0022https:\/\/streamnative.io\/blog\/tech\/2020-03-24-bring-native-kafka-protocol-support-to-apache-pulsar\/\u0022 target=\u0022_blank\u0022\u003eKafka-on-Pulsar (KoP)\u003c\/a\u003e, which is a plugin that makes Pulsar look like a Kafka cluster from an application perspective! Since the compatibility works on the network protocol level, existing clients should continue to work.\u003c\/p\u003e\n\u003cp\u003eIf we could set up a Pulsar cluster with KoP enabled, we should be able to leverage the existing Kafka integration in Druid to ingest data directly from Pulsar. Let’s try it out!\u003c\/p\u003e\n\u003cp\u003eWe will need to install\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003eApache Pulsar and KoP\u003c\/li\u003e\n\u003cli\u003eApache Druid\u003c\/li\u003e\n\u003cli\u003eWe also need a data simulator. This will be a simple script that uses the Pulsar commandline client, so we will also see the mapping between Kafka topic names and Pulsar topic names.\u003c\/li\u003e\n\u003c\/ul\u003e\n\u003cp\u003eI am running all components directly on my laptop.\u003c\/p\u003e\n\u003ch3 id=\u0022installing-pulsar-and-kop\u0022\u003eInstalling Pulsar and KoP\u003c\/h3\u003e\n\u003cp\u003eDownload Pulsar from \u003ca href=\u0022https:\/\/pulsar.apache.org\/en\/download\/\u0022 target=\u0022_blank\u0022\u003ethe Apache Pulsar download website\u003c\/a\u003e, and untar into your home directory. At the time of this writing, the latest release is 2.10.0.\u003c\/p\u003e\n\u003cp\u003eDownload KoP from \u003ca href=\u0022https:\/\/github.com\/streamnative\/kop\/releases\u0022 target=\u0022_blank\u0022\u003eStreamNative’s GitHub repository\u003c\/a\u003e. Make sure that the release number of KoP you download matches your Pulsar release. I am using version 2.10.0.2.\u003c\/p\u003e\n\u003cp\u003eInstall KoP in \u003ccode\u003eapache-pulsar-2.10.0\u003c\/code\u003e directory - you need to create a protocols directory and copy the nar file into it:\u003c\/p\u003e\n\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003e\r\n% cd $HOME\/apache-pulsar-2.10.0\r\n% mkdir protocols\r\n% cp ~\/Downloads\/pulsar-protocol-handler-kafka-2.10.0.2.nar protocols \n\u003c\/code\u003e\u003c\/pre\u003e\u003ch3 id=\u0022configuration-for-kop\u0022\u003eConfiguration for KoP\u003c\/h3\u003e\n\u003cp\u003eYou have to add a few necessary configuration settings to \u003ccode\u003econf\/standalone.conf\u003c\/code\u003e as per \u003ca href=\u0022https:\/\/github.com\/streamnative\/kop\/blob\/master\/docs\/kop.md\u0022 target=\u0022_blank\u0022\u003ehttps:\/\/github.com\/streamnative\/kop\/blob\/master\/docs\/kop.md\u003c\/a\u003e:\u003c\/p\u003e\n\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003e\r\nmessagingProtocols=kafka\r\nprotocolHandlerDirectory=.\/protocols\r\nallowAutoTopicCreationType=partitioned     # !! overrides the default setting !!\r\nkafkaListeners=PLAINTEXT:\/\/127.0.0.1:9092\r\nkafkaAdvertisedListeners=PLAINTEXT:\/\/127.0.0.1:9092\r\nbrokerEntryMetadataInterceptors=org.apache.pulsar.common.intercept.AppendIndexMetadataInterceptor\r\nbrokerDeleteInactiveTopicsEnabled=false    # !! overrides the default setting !!\n\u003c\/code\u003e\u003c\/pre\u003e\u003cp\u003eNote that the settings for allowAutoTopicCreationType and brokerDeleteInactiveTopicsEnabled override the default settings, you have to find the lines with the default settings and edit or remove them.\u003c\/p\u003e\n\u003cp\u003eDruid uses Kafka transactions, so we need one more option to make KoP work with Druid:\u003c\/p\u003e\n\u003cp\u003e\u003ccode\u003ekafkaTransactionCoordinatorEnabled=true    # this is not in the docs but required for Druid\u003c\/code\u003e\u003c\/p\u003e\n\u003ch3 id=\u0022topic-mapping\u0022\u003eTopic Mapping\u003c\/h3\u003e\n\u003cp\u003eWhile Kafka has a flat namespace, Pulsar has a naming scheme tenant\/namespace\/topic. You can set the default tenant and namespace for Kafka topics like so: (In conf\/standalone.conf)\u003c\/p\u003e\n\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003ekafkaTenant=kop\r\nkafkaNamespace=kop\n\u003c\/code\u003e\u003c\/pre\u003e\u003cp\u003eFinally, start Pulsar according to the \u003ca href=\u0022https:\/\/pulsar.apache.org\/docs\/en\/standalone\/\u0022 target=\u0022_blank\u0022\u003estandalone quickstart\u003c\/a\u003e instructions:\u003c\/p\u003e\n\u003cp\u003e\u003ccode\u003e% bin\/pulsar standalone\u003c\/code\u003e\u003c\/p\u003e\n\u003ch2 id=\u0022installing-and-preparing-druid\u0022\u003eInstalling and Preparing Druid\u003c\/h2\u003e\n\u003cp\u003eDownload the latest Druid release from \u003ca href=\u0022https:\/\/druid.apache.org\/downloads.html\u0022 target=\u0022_blank\u0022\u003ethe Apache Druid website\u003c\/a\u003e and untar it into your home directory. We are going to use the Druid quickstart but first we have to solve a little problem.\u003c\/p\u003e\n\u003ch3 id=\u0022port-conflicts\u0022\u003ePort Conflicts\u003c\/h3\u003e\n\u003cp\u003eBoth Druid and Pulsar use Zookeeper for storing cluster state, and both use the default port 2181. Moreover, Druid’s default configuration exposes the Zookeper command API on port 8080, which is used for admin tasks by Pulsar too.\u003c\/p\u003e\n\u003cp\u003eIn a production setup, this would have to be addressed properly. For the purpose of this tutorial, let’s do a simple workaround: We will make Druid use the Zookeeper instance that comes with Pulsar! That means we need to remove Zookeeper from the Druid quickstart.\u003c\/p\u003e\n\u003cp\u003eMake a copy of apache-druid-0.22.1\/conf\/supervise\/single-server\/micro-quickstart.conf and remove the Zookeeper line:\u003c\/p\u003e\n\u003cp\u003e\u003ccode\u003e!p10 zk bin\/run-zk conf\u003c\/code\u003e\u003c\/p\u003e\n\u003cp\u003eSave this file to \u003ccode\u003eapache-druid-0.22.1\/conf\/supervise\/single-server\/micro-quickstart-nozk.conf.\u003c\/code\u003e\u003c\/p\u003e\n\u003cp\u003eMake a copy of \u003ccode\u003ebin\/start-micro-quickstart\u003c\/code\u003e and edit the last line to refer to the new configuration file:\u003c\/p\u003e\n\u003cp\u003e\u003ccode\u003eexec \u0026quot;$WHEREAMI\/supervise\u0026quot; -c \u0026quot;$WHEREAMI\/..\/conf\/supervise\/single-server\/micro-quickstart-nozk.conf\u0026quot;\r \u003c\/code\u003e\nSave this to \u003ccode\u003ebin\/start-micro-quickstart-nozk\u003c\/code\u003e.\u003c\/p\u003e\n\u003cp\u003eWe are ready to start Druid:\u003c\/p\u003e\n\u003cp\u003e\u003ccode\u003e% bin\/start-micro-quickstart-nozk\u003c\/code\u003e\u003c\/p\u003e\n\u003ch3 id=\u0022generating-data\u0022\u003eGenerating Data\u003c\/h3\u003e\n\u003cp\u003eLet’s push some data into Pulsar. I am going to use the CLI client. Note that the namespace convention we configured will make a topic \u003ccode\u003ekop\/kop\/pulsar-to-druid\u003c\/code\u003e appear as pulsar-to-druid on the Kafka side. Here’s my pulsar-produce.sh script:\u003c\/p\u003e\n\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003e#!\/bin\/bash\r\n\r\nexport PULSAR_HOME=$HOME\/apache-pulsar-2.10.0\r\nexport TOPIC=pulsar-to-druid\r\n\r\nwhile true; do\r\n    ${PULSAR_HOME}\/bin\/pulsar-client produce kop\/kop\/pulsar-to-druid -s \u0026#34;\\000\u0026#34; \\\r\n        -m \u0026#34;{ \\\u0026#34;timestamp\\\u0026#34;: \\\u0026#34;$(date -Iseconds)\\\u0026#34;, \\\u0026#34;dim\\\u0026#34;: \\\u0026#34;dim$((1 \u002b RANDOM % 5))\\\u0026#34;, \\\u0026#34;value\\\u0026#34;: \\\u0026#34;$((1 \u002b RANDOM % 100))\\\u0026#34; }\u0026#34;\r\n    sleep 1\r\ndone\n\u003c\/code\u003e\u003c\/pre\u003e\u003cp\u003eThis creates a simulated timeseries of JSON messages with messages once a second. The -s option sets the message separator. The default is \u003ccode\u003e,\u003c\/code\u003e which is not good for JSON.\u003c\/p\u003e\n\u003cp\u003eLet’s test this with a Kafka client:\u003c\/p\u003e\n\u003cpre tabindex=\u00220\u0022\u003e\u003ccode\u003e% kcat -b 127.0.0.1:9092 -t pulsar-to-druid -C           \r\n{ \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-25T15:04:11\u002b02:00\u0026#34;, \u0026#34;dim\u0026#34;: \u0026#34;dim5\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;5\u0026#34; }\r\n{ \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-25T15:04:16\u002b02:00\u0026#34;, \u0026#34;dim\u0026#34;: \u0026#34;dim4\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;30\u0026#34; }\r\n{ \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-25T15:04:21\u002b02:00\u0026#34;, \u0026#34;dim\u0026#34;: \u0026#34;dim3\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;84\u0026#34; }\r\n{ \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-25T15:04:26\u002b02:00\u0026#34;, \u0026#34;dim\u0026#34;: \u0026#34;dim1\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;33\u0026#34; }\r\n{ \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-25T15:04:30\u002b02:00\u0026#34;, \u0026#34;dim\u0026#34;: \u0026#34;dim3\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;92\u0026#34; }\r\n{ \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-25T15:04:35\u002b02:00\u0026#34;, \u0026#34;dim\u0026#34;: \u0026#34;dim3\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;49\u0026#34; }\r\n{ \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-25T15:04:40\u002b02:00\u0026#34;, \u0026#34;dim\u0026#34;: \u0026#34;dim3\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;40\u0026#34; }\r\n{ \u0026#34;timestamp\u0026#34;: \u0026#34;2022-04-25T15:04:45\u002b02:00\u0026#34;, \u0026#34;dim\u0026#34;: \u0026#34;dim2\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;81\u0026#34; }\n\u003c\/code\u003e\u003c\/pre\u003e\u003cp\u003eThis works fine. (Side note: \u003ccode\u003ekcat\u003c\/code\u003e needs Kafka transactions enabled, too!)\u003c\/p\u003e\n\u003ch3 id=\u0022ingesting-pulsar-data-into-druid\u0022\u003eIngesting Pulsar Data into Druid\u003c\/h3\u003e\n\u003cp\u003eLet’s try if we can connect to Pulsar from the Druid console! Start a new ingestion, choose Kafka and enter the connection detail just like you would for Kafka:\u003c\/p\u003e\n\u003cp\u003e\u003cimg src=\u0022https:\/\/user-images.githubusercontent.com\/1042872\/168396156-6449d29b-2b67-4600-b45b-1784c194d065.jpeg\u0022 alt=\u0022Pulsar Druid output\u0022\u003e\u003c\/p\u003e\n\u003cp\u003eAnd from here it’s just \u003ca href=\u0022https:\/\/druid.apache.org\/docs\/0.22.1\/tutorials\/index.html#step-4-load-data\u0022 target=\u0022_blank\u0022\u003estandard steps to ingest data\u003c\/a\u003e!\u003c\/p\u003e\n\u003cp\u003eLearnings\u003c\/p\u003e\n\u003cul\u003e\n\u003cli\u003eWith StreamNative’s KoP, all existing software can talk to Pulsar instead of Kafka.\u003c\/li\u003e\n\u003cli\u003eDruid integration with KoP is a breeze.\u003c\/li\u003e\n\u003cli\u003eSpend some time on the namespace mapping between Kafka emulation and Pulsar.\u003c\/li\u003e\n\u003cli\u003eThe \u003ccode\u003ekafkaTransactionCoordinatorEnabled\u003c\/code\u003e is crucial to make Druid work with KoP.\u003c\/li\u003e\n\u003c\/ul\u003e\n"}]</script></head><body class='page bg-secondary'><div id=main-menu-mobile class=main-menu-mobile><ul></ul></div><div class=wrapper><div class='header sticky-top bg-secondary'><div class=container><div class=logo><a href=https://www.pulsar-neighborhood.io><img src=/svg/Pulsar-Neighborhood-Logo.svg class=img-fluid></a></div><div class=logo-mobile><a href=https://www.pulsar-neighborhood.io><img src=/svg/Neighborhood-Icon.svg class=img-fluid></a></div><div id=main-menu class=main-menu><ul><li><a href=/about><span>About The Pulsar Neighborhood</span></a></li><li><a href=https://pulsar.apache.org/ target=_blank><span>About Apache Pulsar</span></a></li><li><a href=https://pulsar.apache.org/docs/en/standalone/ target=_blank><span></span>Project Documentation</span></a></li><li><a href=/index.xml><img src=/svg/square-rss-solid.svg title="Subscribe to The Pulsar Neighborhood feed" class=img-fluid style=height:30px></a></li></ul></div><button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button>
<span class=hamburger-box><span class=hamburger-inner></span></span></button></div></div><div class="container pt-2 pb-3"><div class=row><div class="col-0 col-md-2"><div class=sidebar><div class=mb-2><a href=/guides/getting-started><div class="col-12 btn btn-success">Get Started with Pulsar</div></a></div><div class="spotlight mb-2 border border-primary rounded"><div class="row bg-primary no-gutters"><div class="col-12 text-secondary p-1">&nbsp;Find Topics</div></div><div class=p-1><div class="row no-gutters"><div class="col-12 mb-1"><h4>Category</h4><ul><li>&nbsp;<a class=text-decoration-none href=/categories/at-the-edge>At the Edge</a> [3]</li><li>&nbsp;<a class=text-decoration-none href=/categories/cluster-administration>Cluster Administration</a> [3]</li><li>&nbsp;<a class=text-decoration-none href=/categories/getting-started>Getting Started</a> [15]</li><li>&nbsp;<a class=text-decoration-none href=/categories/machine-learning>Machine Learning</a> [2]</li><li>&nbsp;<a class=text-decoration-none href=/categories/moving-to-pulsar>Moving to Pulsar</a> [11]</li><li>&nbsp;<a class=text-decoration-none href=/categories/pulsar-architecture>Pulsar Architecture</a> [10]</li><li>&nbsp;<a class=text-decoration-none href=/categories/pulsar-components>Pulsar Components</a> [9]</li><li>&nbsp;<a class=text-decoration-none href=/categories/use-cases>Use Cases</a> [6]</li></ul></div><div class=col-12><h4>View All</h4><div class="mt-1 pb-1"><a href=/articles>Articles</a>
&nbsp;|&nbsp;<a href=/guides>Guides</a>
&nbsp;|&nbsp;<a href=/videos>Videos</a></div></div></div></div></div></div></div><div class="col-12 col-md-8"><div class=container><header class=mb-3><div class=pb-2></div><h1>Integrating Apache Druid With Apache Pulsar</h1><div class="row no-gutters"><div class="col col-auto mr-1">Categories:</div><div class="col col-auto"><a class=text-decoration-none href=/categories/machine-learning>Machine Learning</a>,&nbsp;</div><div class="col col-auto"><a class=text-decoration-none href=/categories/moving-to-pulsar>Moving to Pulsar</a></div></div></header><div class="row mb-3 no-gutters border-top border-bottom"><div class=col-2><ul class="list-group list-group-horizontal mt-1 mb-1"><li class="list-group-item flex-fill border-0 p-0 mr-3"><a href="https://www.linkedin.com/sharing/share-offsite/?mini=true&url=https%3a%2f%2fwww.pulsar-neighborhood.io%2farticles%2fintegrating-apache-druid-with-apache-pulsar%2f&title=Integrating%20Apache%20Druid%20With%20Apache%20Pulsar" target=_blank><img src=/svg/linkedin-in-brands.svg title="Share this on LinkedIn" class=img-fluid></a></li><li class="list-group-item flex-fill border-0 p-0 mr-3"><a target=_blank href="https://twitter.com/intent/tweet?text=Integrating%20Apache%20Druid%20With%20Apache%20Pulsar&url=https%3a%2f%2fwww.pulsar-neighborhood.io%2farticles%2fintegrating-apache-druid-with-apache-pulsar%2f&hashtags=apachepulsar&via=pulsar_neighbor"><img src=/svg/twitter-brands.svg title="Share this on Twitter" class=img-fluid></a></li></ul></div><div class="col text-right"><span class=text-muted>Author:</span> Hellmar Becker<br><span class=text-muted>Published:</span> May 18, 2022</div></div><article><p>This blog post originally appeared on <a href=https://blog.hellmar-becker.de/2022/04/25/integrating-apache-druid-with-apache-pulsar/ target=_blank>blog.hellmar-becker.de</a></p><p><img src=https://user-images.githubusercontent.com/1042872/168392825-24f2ef83-c646-46dc-a5e5-c20eb7f7f0c5.png alt="Pulsar and Druid banner"></p><p>With companies adopting the <a href=https://medium.com/capital-one-tech/event-streaming-an-additional-architectural-style-to-supplement-api-design-703c4f801722 target=_blank>event streaming pattern</a>, analytics has to become more &ldquo;realtime&rdquo; too. A great database for event analytics is <a href=https://druid.apache.org/ target=_blank>Apache Druid</a>. Druid connects natively to various event streaming systems such as Kafka and AWS Kinesis.</p><p>One of the most advanced modern event streaming platforms is <a href=https://pulsar.apache.org/ target=_blank>Apache Pulsar</a>. Pulsar has a cloud native architecture that separates the storage layer from the message brokers, claiming unprecendented scalability and flexibility. Sure it would be great to stream events directly from Pulsar into Druid!</p><p>The idea has been discussed before <a href=https://imply.io/blog/community-spotlight-apache-pulsar-and-apache-druid-get-close/ target=_blank>by the Imply and StreamNative teams</a>, but up until recently no turnkey solution existed. Pulsar offered a drop-in client library with call compatibility to the Kafka libraries, but using it would usually require rebuilding the entire application, which is not for everyone.</p><p>Recently, the folks at <a href=https://streamnative.io/ target=_blank>StreamNative</a> released <a href=https://streamnative.io/blog/tech/2020-03-24-bring-native-kafka-protocol-support-to-apache-pulsar/ target=_blank>Kafka-on-Pulsar (KoP)</a>, which is a plugin that makes Pulsar look like a Kafka cluster from an application perspective! Since the compatibility works on the network protocol level, existing clients should continue to work.</p><p>If we could set up a Pulsar cluster with KoP enabled, we should be able to leverage the existing Kafka integration in Druid to ingest data directly from Pulsar. Let’s try it out!</p><p>We will need to install</p><ul><li>Apache Pulsar and KoP</li><li>Apache Druid</li><li>We also need a data simulator. This will be a simple script that uses the Pulsar commandline client, so we will also see the mapping between Kafka topic names and Pulsar topic names.</li></ul><p>I am running all components directly on my laptop.</p><h3 id=installing-pulsar-and-kop>Installing Pulsar and KoP</h3><p>Download Pulsar from <a href=https://pulsar.apache.org/en/download/ target=_blank>the Apache Pulsar download website</a>, and untar into your home directory. At the time of this writing, the latest release is 2.10.0.</p><p>Download KoP from <a href=https://github.com/streamnative/kop/releases target=_blank>StreamNative’s GitHub repository</a>. Make sure that the release number of KoP you download matches your Pulsar release. I am using version 2.10.0.2.</p><p>Install KoP in <code>apache-pulsar-2.10.0</code> directory - you need to create a protocols directory and copy the nar file into it:</p><pre tabindex=0><code>
% cd $HOME/apache-pulsar-2.10.0
% mkdir protocols
% cp ~/Downloads/pulsar-protocol-handler-kafka-2.10.0.2.nar protocols 
</code></pre><h3 id=configuration-for-kop>Configuration for KoP</h3><p>You have to add a few necessary configuration settings to <code>conf/standalone.conf</code> as per <a href=https://github.com/streamnative/kop/blob/master/docs/kop.md target=_blank>https://github.com/streamnative/kop/blob/master/docs/kop.md</a>:</p><pre tabindex=0><code>
messagingProtocols=kafka
protocolHandlerDirectory=./protocols
allowAutoTopicCreationType=partitioned     # !! overrides the default setting !!
kafkaListeners=PLAINTEXT://127.0.0.1:9092
kafkaAdvertisedListeners=PLAINTEXT://127.0.0.1:9092
brokerEntryMetadataInterceptors=org.apache.pulsar.common.intercept.AppendIndexMetadataInterceptor
brokerDeleteInactiveTopicsEnabled=false    # !! overrides the default setting !!
</code></pre><p>Note that the settings for allowAutoTopicCreationType and brokerDeleteInactiveTopicsEnabled override the default settings, you have to find the lines with the default settings and edit or remove them.</p><p>Druid uses Kafka transactions, so we need one more option to make KoP work with Druid:</p><p><code>kafkaTransactionCoordinatorEnabled=true # this is not in the docs but required for Druid</code></p><h3 id=topic-mapping>Topic Mapping</h3><p>While Kafka has a flat namespace, Pulsar has a naming scheme tenant/namespace/topic. You can set the default tenant and namespace for Kafka topics like so: (In conf/standalone.conf)</p><pre tabindex=0><code>kafkaTenant=kop
kafkaNamespace=kop
</code></pre><p>Finally, start Pulsar according to the <a href=https://pulsar.apache.org/docs/en/standalone/ target=_blank>standalone quickstart</a> instructions:</p><p><code>% bin/pulsar standalone</code></p><h2 id=installing-and-preparing-druid>Installing and Preparing Druid</h2><p>Download the latest Druid release from <a href=https://druid.apache.org/downloads.html target=_blank>the Apache Druid website</a> and untar it into your home directory. We are going to use the Druid quickstart but first we have to solve a little problem.</p><h3 id=port-conflicts>Port Conflicts</h3><p>Both Druid and Pulsar use Zookeeper for storing cluster state, and both use the default port 2181. Moreover, Druid’s default configuration exposes the Zookeper command API on port 8080, which is used for admin tasks by Pulsar too.</p><p>In a production setup, this would have to be addressed properly. For the purpose of this tutorial, let’s do a simple workaround: We will make Druid use the Zookeeper instance that comes with Pulsar! That means we need to remove Zookeeper from the Druid quickstart.</p><p>Make a copy of apache-druid-0.22.1/conf/supervise/single-server/micro-quickstart.conf and remove the Zookeeper line:</p><p><code>!p10 zk bin/run-zk conf</code></p><p>Save this file to <code>apache-druid-0.22.1/conf/supervise/single-server/micro-quickstart-nozk.conf.</code></p><p>Make a copy of <code>bin/start-micro-quickstart</code> and edit the last line to refer to the new configuration file:</p><p><code>exec "$WHEREAMI/supervise" -c "$WHEREAMI/../conf/supervise/single-server/micro-quickstart-nozk.conf"
</code>Save this to <code>bin/start-micro-quickstart-nozk</code>.</p><p>We are ready to start Druid:</p><p><code>% bin/start-micro-quickstart-nozk</code></p><h3 id=generating-data>Generating Data</h3><p>Let’s push some data into Pulsar. I am going to use the CLI client. Note that the namespace convention we configured will make a topic <code>kop/kop/pulsar-to-druid</code> appear as pulsar-to-druid on the Kafka side. Here’s my pulsar-produce.sh script:</p><pre tabindex=0><code>#!/bin/bash

export PULSAR_HOME=$HOME/apache-pulsar-2.10.0
export TOPIC=pulsar-to-druid

while true; do
    ${PULSAR_HOME}/bin/pulsar-client produce kop/kop/pulsar-to-druid -s &#34;\000&#34; \
        -m &#34;{ \&#34;timestamp\&#34;: \&#34;$(date -Iseconds)\&#34;, \&#34;dim\&#34;: \&#34;dim$((1 + RANDOM % 5))\&#34;, \&#34;value\&#34;: \&#34;$((1 + RANDOM % 100))\&#34; }&#34;
    sleep 1
done
</code></pre><p>This creates a simulated timeseries of JSON messages with messages once a second. The -s option sets the message separator. The default is <code>,</code> which is not good for JSON.</p><p>Let’s test this with a Kafka client:</p><pre tabindex=0><code>% kcat -b 127.0.0.1:9092 -t pulsar-to-druid -C           
{ &#34;timestamp&#34;: &#34;2022-04-25T15:04:11+02:00&#34;, &#34;dim&#34;: &#34;dim5&#34;, &#34;value&#34;: &#34;5&#34; }
{ &#34;timestamp&#34;: &#34;2022-04-25T15:04:16+02:00&#34;, &#34;dim&#34;: &#34;dim4&#34;, &#34;value&#34;: &#34;30&#34; }
{ &#34;timestamp&#34;: &#34;2022-04-25T15:04:21+02:00&#34;, &#34;dim&#34;: &#34;dim3&#34;, &#34;value&#34;: &#34;84&#34; }
{ &#34;timestamp&#34;: &#34;2022-04-25T15:04:26+02:00&#34;, &#34;dim&#34;: &#34;dim1&#34;, &#34;value&#34;: &#34;33&#34; }
{ &#34;timestamp&#34;: &#34;2022-04-25T15:04:30+02:00&#34;, &#34;dim&#34;: &#34;dim3&#34;, &#34;value&#34;: &#34;92&#34; }
{ &#34;timestamp&#34;: &#34;2022-04-25T15:04:35+02:00&#34;, &#34;dim&#34;: &#34;dim3&#34;, &#34;value&#34;: &#34;49&#34; }
{ &#34;timestamp&#34;: &#34;2022-04-25T15:04:40+02:00&#34;, &#34;dim&#34;: &#34;dim3&#34;, &#34;value&#34;: &#34;40&#34; }
{ &#34;timestamp&#34;: &#34;2022-04-25T15:04:45+02:00&#34;, &#34;dim&#34;: &#34;dim2&#34;, &#34;value&#34;: &#34;81&#34; }
</code></pre><p>This works fine. (Side note: <code>kcat</code> needs Kafka transactions enabled, too!)</p><h3 id=ingesting-pulsar-data-into-druid>Ingesting Pulsar Data into Druid</h3><p>Let’s try if we can connect to Pulsar from the Druid console! Start a new ingestion, choose Kafka and enter the connection detail just like you would for Kafka:</p><p><img src=https://user-images.githubusercontent.com/1042872/168396156-6449d29b-2b67-4600-b45b-1784c194d065.jpeg alt="Pulsar Druid output"></p><p>And from here it’s just <a href=https://druid.apache.org/docs/0.22.1/tutorials/index.html#step-4-load-data target=_blank>standard steps to ingest data</a>!</p><p>Learnings</p><ul><li>With StreamNative’s KoP, all existing software can talk to Pulsar instead of Kafka.</li><li>Druid integration with KoP is a breeze.</li><li>Spend some time on the namespace mapping between Kafka emulation and Pulsar.</li><li>The <code>kafkaTransactionCoordinatorEnabled</code> is crucial to make Druid work with KoP.</li></ul></article><div class="row border border-primary rounded"><div class="col p-2"><h3>You might also like...</h3><div class=row><div class="col text-center p-2"><div><a href=/articles/do-i-have-time-to-learn-event-streaming/><img src=https://user-images.githubusercontent.com/16946028/168359869-21a4d6b6-b761-43c9-8b1d-2a5d3ee2f83c.png alt class=img-fluid style=max-width:150px></a></div><div class=pt-2><a href=/articles/do-i-have-time-to-learn-event-streaming/>Do I Have Time to Learn Event Streaming?</a></div><div class=pt-2>In this article, we’ll explore what event streaming is, how it works, and discuss the growing …</div></div><div class="col text-center p-2"><div><a href=/articles/moving-from-java-message-service-jms-to-apache-pulsar/><img src=https://user-images.githubusercontent.com/16946028/168343481-a852dd84-ffd5-449d-ab85-14fd317a9685.png alt class=img-fluid style=max-width:150px></a></div><div class=pt-2><a href=/articles/moving-from-java-message-service-jms-to-apache-pulsar/>Moving from Java Message Service (JMS) to Apache Pulsar</a></div><div class=pt-2>Let’s explore some advantages and challenges of moving from JMS to Pulsar.</div></div><div class="col text-center p-2"><div><a href=/articles/apache-pulsar-versus-apache-kafka/><img src=https://user-images.githubusercontent.com/16946028/163627966-dc0b4e18-d7ac-4d75-889f-2844926d11be.png alt class=img-fluid style=max-width:150px></a></div><div class=pt-2><a href=/articles/apache-pulsar-versus-apache-kafka/>Apache Pulsar Versus Apache Kafka</a></div><div class=pt-2>In this article, we'll evaluate the features, architectures, performance, and use cases of Apache …</div></div></div></div></div><br><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var t,e=document.createElement("script");e.type="text/javascript",e.async=!0,t="pulsar-neighborhood",e.src="//"+t+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div><div class="col-0 col-md-2"><nav class="navbar navbar-light mb-3"><div class=row><div class=col-12><h4>In this article</h4></div><div class="col-12 border-left border-primary pr-0"><nav id=TableOfContents><ul><li><ul><li><a href=#installing-pulsar-and-kop>Installing Pulsar and KoP</a></li><li><a href=#configuration-for-kop>Configuration for KoP</a></li><li><a href=#topic-mapping>Topic Mapping</a></li></ul></li><li><a href=#installing-and-preparing-druid>Installing and Preparing Druid</a><ul><li><a href=#port-conflicts>Port Conflicts</a></li><li><a href=#generating-data>Generating Data</a></li><li><a href=#ingesting-pulsar-data-into-druid>Ingesting Pulsar Data into Druid</a></li></ul></li></ul></nav></div></div></nav></div></div></div></div><div class="sub-footer m-5"><div class=row><div class="col-12 text-center"><a href=https://github.com/pulsar-neighborhood/pulsar-neighborhood.github.io/blob/main/content/articles/Integrating-Apache-Druid-with-Apache-Pulsar.md target=_blank>Improve this page</a></div></div><div class="col-8 offset-2"><hr class="bg-primary text-primary"></div><div class="sub-footer-inner mt-2"><div><div class=mb-1>Pulsar Neighborhood</div><div><ul><li style=width:40px><a href=https://github.com/pulsar-neighborhood target=_blank><img src=/svg/github-brands.svg title="Pulsar Neighborhood on GitHub" class=img-fluid></a></li><li class="ml-3 mr-1" style=width:40px><a href=https://twitter.com/pulsar_neighbor target=_blank><img src=/svg/twitter-brands.svg title="Pulsar Neighborhood on Twitter" class=img-fluid></a></li><li style=width:40px><a href=https://www.youtube.com/c/ApachePulsarNeighborhood target=_blank><img src=/svg/youtube-brands.svg title="Pulsar Neighborhood on YouTube" class=img-fluid></a></li><li style=width:40px><a href=https://datastudio.google.com/reporting/743d9f31-c80f-4e60-b520-730631d3c250 target=_blank><img src=/png/google-analytics.png title="Pulsar Neighborhood analytics" class=img-fluid></a></li></ul></div></div><div class=p-5></div><div><div class=mb-1>Apache Pulsar</div><div><ul><li style=width:40px><a href=https://pulsar.apache.org target=_blank><img src=/png/pulsar-icon.jpg title="Apache Pulsar project home" class=img-fluid></a></li><li class="ml-3 mr-1" style=width:40px><a href=https://github.com/apache-pulsar target=_blank><img src=/svg/github-brands.svg title="Apache Pulsar on GitHub" class=img-fluid></a></li><li class=mr-1 style=width:40px><a href=https://twitter.com/Apache_Pulsar target=_blank><img src=/svg/twitter-brands.svg title="Apache Pulsar on Twitter" class=img-fluid></a></li><li class=mr-1 style=width:30px><a href=https://stackoverflow.com/questions/tagged/apache-pulsar target=_blank><img src=/svg/stack-overflow-brands.svg title="Apache Pulsar on Stackoverflow" class=img-fluid></a></li><li style=width:40px><a href=https://apache-pulsar.slack.com target=_blank><img src=/svg/slack-brands.svg title="Apache Pulsar slack channel" class=img-fluid></a></li></ul></div></div></div><div class="row text-center mb-3"><div class=col-12><a class="btn btn-info" href=https://pulsar.apache.org/community/ target=_blank>Join the Pulsar community</a></div></div><div class="row text-center"><div class="col-12 text-center"><div><a href=https://github.com/pulsar-neighborhood/pulsar-neighborhood.github.io/issues/new/choose>Contact Us</a></div></div></div></div><script type=text/javascript src=/js/scripts.min.8efe3e711319c2d0a300a084134e3f3bedcb60dce21f1e0ef12767f654242b44.js></script><script src=https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js integrity=sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-8S9SD43SBH"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-8S9SD43SBH")</script></body></html>